---
/**
 * Chart component for MDX blog posts
 * Uses Chart.js for rendering various chart types
 *
 * Usage in MDX:
 * <Chart
 *   type="bar"
 *   data={{
 *     labels: ['A', 'B', 'C'],
 *     datasets: [{ label: 'Values', data: [1, 2, 3] }]
 *   }}
 * />
 */
interface Props {
	type: 'bar' | 'line' | 'pie' | 'doughnut' | 'radar' | 'scatter';
	data: {
		labels?: string[];
		datasets: Array<{
			label?: string;
			data: number[];
			backgroundColor?: string | string[];
			borderColor?: string | string[];
			borderWidth?: number;
			fill?: boolean;
		}>;
	};
	options?: Record<string, unknown>;
	width?: number;
	height?: number;
}

const { type, data, options = {}, width, height } = Astro.props;

// Generate unique ID for this chart instance
const chartId = `chart-${Math.random().toString(36).substr(2, 9)}`;

// Pass raw data to client-side script for theme-aware rendering
const rawData = data;
const hasScales = type !== 'pie' && type !== 'doughnut' && type !== 'radar';
const userOptions = options;
---

<div class="chart-container">
	<canvas id={chartId} width={width} height={height}></canvas>
</div>

<script define:vars={{ chartId, type, rawData, hasScales, userOptions }}>
	// Detect current theme
	function isDarkMode() {
		const dataTheme = document.documentElement.getAttribute('data-theme');
		if (dataTheme === 'light') return false;
		if (dataTheme === 'dark') return true;
		// Fall back to system preference
		return !window.matchMedia('(prefers-color-scheme: light)').matches;
	}

	// Theme-aware colors - high contrast for visibility
	function getColors(isDark) {
		if (isDark) {
			// Light colors on dark background
			return {
				colors: [
					'rgba(255, 255, 255, 0.9)',
					'rgba(180, 180, 180, 0.9)',
					'rgba(255, 255, 255, 0.6)',
					'rgba(180, 180, 180, 0.6)',
					'rgba(220, 220, 220, 0.9)',
				],
				borders: [
					'rgb(255, 255, 255)',
					'rgb(180, 180, 180)',
					'rgb(255, 255, 255)',
					'rgb(180, 180, 180)',
					'rgb(220, 220, 220)',
				],
				text: 'rgb(229, 229, 229)',
				grid: 'rgba(255, 255, 255, 0.1)',
			};
		}
		// Dark colors on light background
		return {
			colors: [
				'rgba(55, 65, 81, 0.9)',
				'rgba(107, 114, 128, 0.9)',
				'rgba(55, 65, 81, 0.6)',
				'rgba(107, 114, 128, 0.6)',
				'rgba(75, 85, 99, 0.9)',
			],
			borders: [
				'rgb(55, 65, 81)',
				'rgb(107, 114, 128)',
				'rgb(55, 65, 81)',
				'rgb(107, 114, 128)',
				'rgb(75, 85, 99)',
			],
			text: 'rgb(55, 65, 81)',
			grid: 'rgba(55, 65, 81, 0.15)',
		};
	}

	let chartInstance = null;

	function createChart(Chart) {
		const ctx = document.getElementById(chartId);
		if (!ctx) return;

		// Destroy existing chart if any
		if (chartInstance) {
			chartInstance.destroy();
		}

		const isDark = isDarkMode();
		const { colors, borders, text, grid } = getColors(isDark);

		const processedData = {
			...rawData,
			datasets: rawData.datasets.map((dataset, index) => ({
				...dataset,
				backgroundColor: dataset.backgroundColor || colors[index % colors.length],
				borderColor: dataset.borderColor || borders[index % borders.length],
				borderWidth: dataset.borderWidth ?? 2,
			})),
		};

		const chartOptions = {
			responsive: true,
			maintainAspectRatio: true,
			plugins: {
				legend: {
					labels: {
						color: text,
						font: {
							family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
						},
					},
				},
			},
			scales: hasScales ? {
				x: {
					ticks: {
						color: text,
						font: {
							family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
						},
					},
					grid: { color: grid },
				},
				y: {
					ticks: {
						color: text,
						font: {
							family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
						},
					},
					grid: { color: grid },
				},
			} : undefined,
			...userOptions,
		};

		chartInstance = new Chart(ctx, {
			type: type,
			data: processedData,
			options: chartOptions,
		});
	}

	// Dynamic import Chart.js only when needed
	import('https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js').then(() => {
		const Chart = window.Chart;

		// Create initial chart
		createChart(Chart);

		// Watch for theme changes and recreate chart
		const observer = new MutationObserver((mutations) => {
			for (const mutation of mutations) {
				if (mutation.attributeName === 'data-theme') {
					createChart(Chart);
					break;
				}
			}
		});

		observer.observe(document.documentElement, {
			attributes: true,
			attributeFilter: ['data-theme'],
		});
	});
</script>

<style>
	.chart-container {
		width: 100%;
		max-width: 600px;
		margin: 2em auto;
		padding: 1em;
		background: var(--bg-secondary);
		border-radius: 8px;
		border: 1px solid rgb(var(--border));
	}
</style>
