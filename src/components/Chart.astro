---
/**
 * Chart component for MDX blog posts
 * Uses Chart.js for rendering various chart types
 *
 * Usage in MDX:
 * <Chart
 *   type="bar"
 *   data={{
 *     labels: ['A', 'B', 'C'],
 *     datasets: [{ label: 'Values', data: [1, 2, 3] }]
 *   }}
 * />
 */
interface Props {
	type: 'bar' | 'line' | 'pie' | 'doughnut' | 'radar' | 'scatter';
	data: {
		labels?: string[];
		datasets: Array<{
			label?: string;
			data: number[];
			backgroundColor?: string | string[];
			borderColor?: string | string[];
			borderWidth?: number;
			fill?: boolean;
		}>;
	};
	options?: Record<string, unknown>;
	width?: number;
	height?: number;
}

const { type, data, options = {}, width, height } = Astro.props;

// Generate unique ID for this chart instance
const chartId = `chart-${Math.random().toString(36).substr(2, 9)}`;

// Pass raw data to client-side script for theme-aware rendering
const rawData = data;
const hasScales = type !== 'pie' && type !== 'doughnut' && type !== 'radar';
const userOptions = options;
---

<div class="chart-container">
	<canvas id={chartId} width={width} height={height}></canvas>
</div>

<script define:vars={{ chartId, type, rawData, hasScales, userOptions }}>
	// Detect current theme
	function isDarkMode() {
		const dataTheme = document.documentElement.getAttribute('data-theme');
		if (dataTheme === 'light') return false;
		if (dataTheme === 'dark') return true;
		// Fall back to system preference
		return !window.matchMedia('(prefers-color-scheme: light)').matches;
	}

	// Theme-aware colors - using teal and coral accent colors
	function getColors(isDark) {
		if (isDark) {
			// Vibrant colors on dark background
			return {
				colors: [
					'rgba(45, 212, 191, 0.85)',   // Teal (primary)
					'rgba(244, 162, 97, 0.85)',   // Coral/Orange (secondary)
					'rgba(94, 234, 212, 0.75)',   // Light teal
					'rgba(249, 196, 154, 0.75)',  // Light coral
					'rgba(129, 230, 217, 0.8)',   // Medium teal
				],
				borders: [
					'rgb(45, 212, 191)',
					'rgb(244, 162, 97)',
					'rgb(94, 234, 212)',
					'rgb(249, 196, 154)',
					'rgb(129, 230, 217)',
				],
				text: 'rgb(244, 244, 245)',
				grid: 'rgba(63, 63, 70, 0.5)',
			};
		}
		// Vibrant colors on light background
		return {
			colors: [
				'rgba(13, 148, 136, 0.85)',    // Teal (primary)
				'rgba(224, 122, 95, 0.85)',    // Coral (secondary)
				'rgba(20, 184, 166, 0.75)',    // Light teal
				'rgba(239, 154, 129, 0.75)',   // Light coral
				'rgba(45, 212, 191, 0.8)',     // Medium teal
			],
			borders: [
				'rgb(13, 148, 136)',
				'rgb(224, 122, 95)',
				'rgb(20, 184, 166)',
				'rgb(239, 154, 129)',
				'rgb(45, 212, 191)',
			],
			text: 'rgb(41, 37, 36)',
			grid: 'rgba(214, 211, 209, 0.7)',
		};
	}

	let chartInstance = null;

	function createChart(Chart) {
		const ctx = document.getElementById(chartId);
		if (!ctx) return;

		// Destroy existing chart if any
		if (chartInstance) {
			chartInstance.destroy();
		}

		const isDark = isDarkMode();
		const { colors, borders, text, grid } = getColors(isDark);

		const processedData = {
			...rawData,
			datasets: rawData.datasets.map((dataset, index) => ({
				...dataset,
				backgroundColor: dataset.backgroundColor || colors[index % colors.length],
				borderColor: dataset.borderColor || borders[index % borders.length],
				borderWidth: dataset.borderWidth ?? 2,
			})),
		};

		const chartOptions = {
			responsive: true,
			maintainAspectRatio: true,
			plugins: {
				legend: {
					labels: {
						color: text,
						font: {
							family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
						},
					},
				},
			},
			scales: hasScales ? {
				x: {
					ticks: {
						color: text,
						font: {
							family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
						},
					},
					grid: { color: grid },
				},
				y: {
					ticks: {
						color: text,
						font: {
							family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
						},
					},
					grid: { color: grid },
				},
			} : undefined,
			...userOptions,
		};

		chartInstance = new Chart(ctx, {
			type: type,
			data: processedData,
			options: chartOptions,
		});
	}

	// Dynamic import Chart.js only when needed
	import('https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js').then(() => {
		const Chart = window.Chart;

		// Create initial chart
		createChart(Chart);

		// Watch for theme changes and recreate chart
		const observer = new MutationObserver((mutations) => {
			for (const mutation of mutations) {
				if (mutation.attributeName === 'data-theme') {
					createChart(Chart);
					break;
				}
			}
		});

		observer.observe(document.documentElement, {
			attributes: true,
			attributeFilter: ['data-theme'],
		});
	});
</script>

<style>
	.chart-container {
		width: 100%;
		max-width: 600px;
		margin: 2em auto;
		padding: 1.5em;
		background: var(--bg-secondary);
		border-radius: 12px;
		border: 1px solid rgb(var(--border));
		box-shadow: var(--box-shadow);
		transition: background-color 0.3s ease, border-color 0.3s ease;
	}
</style>
