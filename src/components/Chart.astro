---
/**
 * Chart component for MDX blog posts
 * Uses Chart.js for rendering various chart types
 *
 * Usage in MDX:
 * <Chart
 *   type="bar"
 *   data={{
 *     labels: ['A', 'B', 'C'],
 *     datasets: [{ label: 'Values', data: [1, 2, 3] }]
 *   }}
 * />
 */
interface Props {
	type: 'bar' | 'line' | 'pie' | 'doughnut' | 'radar' | 'scatter';
	data: {
		labels?: string[];
		datasets: Array<{
			label?: string;
			data: number[];
			backgroundColor?: string | string[];
			borderColor?: string | string[];
			borderWidth?: number;
			fill?: boolean;
		}>;
	};
	options?: Record<string, unknown>;
	width?: number;
	height?: number;
}

const { type, data, options = {}, width, height } = Astro.props;

// Generate unique ID for this chart instance
const chartId = `chart-${Math.random().toString(36).substr(2, 9)}`;

// Default colors that work well with the minimal theme
const defaultColors = [
	'rgba(23, 23, 23, 0.8)',
	'rgba(115, 115, 115, 0.8)',
	'rgba(23, 23, 23, 0.5)',
	'rgba(115, 115, 115, 0.5)',
	'rgba(38, 38, 38, 0.8)',
];

const defaultBorderColors = [
	'rgb(23, 23, 23)',
	'rgb(115, 115, 115)',
	'rgb(23, 23, 23)',
	'rgb(115, 115, 115)',
	'rgb(38, 38, 38)',
];

// Apply default colors if not specified
const processedData = {
	...data,
	datasets: data.datasets.map((dataset, index) => ({
		...dataset,
		backgroundColor: dataset.backgroundColor || defaultColors[index % defaultColors.length],
		borderColor: dataset.borderColor || defaultBorderColors[index % defaultBorderColors.length],
		borderWidth: dataset.borderWidth ?? 2,
	})),
};

// Merge default options with provided options
const chartOptions = {
	responsive: true,
	maintainAspectRatio: true,
	plugins: {
		legend: {
			labels: {
				font: {
					family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
				},
			},
		},
	},
	scales: type !== 'pie' && type !== 'doughnut' && type !== 'radar' ? {
		x: {
			ticks: {
				font: {
					family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
				},
			},
		},
		y: {
			ticks: {
				font: {
					family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
				},
			},
		},
	} : undefined,
	...options,
};
---

<div class="chart-container">
	<canvas id={chartId} width={width} height={height}></canvas>
</div>

<script define:vars={{ chartId, type, processedData, chartOptions }}>
	// Dynamic import Chart.js only when needed
	import('https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js').then((module) => {
		const Chart = window.Chart;
		const ctx = document.getElementById(chartId);
		if (ctx) {
			new Chart(ctx, {
				type: type,
				data: processedData,
				options: chartOptions,
			});
		}
	});
</script>

<style>
	.chart-container {
		width: 100%;
		max-width: 600px;
		margin: 2em auto;
		padding: 1em;
		background: #fff;
		border-radius: 8px;
		box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
	}
</style>
